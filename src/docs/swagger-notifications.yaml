paths:
  /notifications/register-token:
    post:
      tags:
        - Notifications
      summary: Register Firebase Cloud Messaging (FCM) token
      description: |
        Register or update a Firebase Cloud Messaging token for push notifications.

        This endpoint allows both customers and admins to register their FCM tokens.
        When an order is created (for admins) or order status changes (for customers),
        push notifications will be sent to all registered tokens.

        **For Customers:**
        - Register with `phone_number` to receive order status updates
        - Notifications sent when order status changes (pending → accepted → ordered, etc.)

        **For Admins:**
        - Register with `admin_email` to receive new order notifications
        - Notifications sent when new orders are created

        **Important Notes:**
        - Tokens are automatically updated if the same user and token combination already exists
        - Multiple tokens can be registered per user (for multiple devices)
        - Invalid tokens are automatically removed from the database
        - Push notifications work alongside Socket.IO notifications
        - Either `phone_number` OR `admin_email` must be provided, but not both
      operationId: registerFcmToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterFcmTokenRequest'
            examples:
              customer_registration:
                summary: Customer FCM token registration
                description: Register FCM token for a customer to receive order status updates
                value:
                  phone_number: "+1234567890"
                  token: "dGhpcyBpcyBhIGZha2UgZmlyZWJhc2UgdG9rZW4gZm9yIGRlbW9uc3RyYXRpb24="
                  device_type: "android"
              admin_registration:
                summary: Admin FCM token registration
                description: Register FCM token for an admin to receive new order notifications
                value:
                  admin_email: "admin@company.com"
                  token: "dGhpcyBpcyBhIGZha2UgZmlyZWJhc2UgdG9rZW4gZm9yIGRlbW9uc3RyYXRpb24="
                  device_type: "web"
      responses:
        '200':
          description: FCM token registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/FcmToken'
                  message:
                    type: string
                    examples:
                      customer: "Customer FCM token registered successfully for +1234567890"
                      admin: "Admin FCM token registered successfully for admin@company.com"
        '400':
          description: Validation error or invalid data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    examples:
                      missing_user: "Either phone_number (for customers) or admin_email (for admins) must be provided"
                      both_provided: "Cannot provide both phone_number and admin_email. Choose one based on user type"
                      invalid_phone: "Invalid phone number format - must be 7-20 characters"
                      invalid_email: "Invalid admin email format"
                      invalid_token: "FCM token is required"
                      invalid_device: "Invalid device type. Must be one of: android, ios, web, other"
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    RegisterFcmTokenRequest:
      type: object
      required:
        - phone_number
        - token
      properties:
        phone_number:
          type: string
          minLength: 7
          maxLength: 20
          description: User's phone number
          example: "+1234567890"
        token:
          type: string
          description: Firebase Cloud Messaging registration token
          example: "dGhpcyBpcyBhIGZha2UgZmlyZWJhc2UgdG9rZW4gZm9yIGRlbW9uc3RyYXRpb24="
        device_type:
          type: string
          enum: [android, ios, web, other]
          description: Optional device type identifier
          example: "android"
    
    FcmToken:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the FCM token record
          example: "123e4567-e89b-12d3-a456-426614174000"
        phone_number:
          type: string
          description: User's phone number
          example: "+1234567890"
        token:
          type: string
          description: Firebase Cloud Messaging registration token
          example: "dGhpcyBpcyBhIGZha2UgdG9rZW4="
        device_type:
          type: string
          nullable: true
          description: Device type identifier
          example: "android"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the token was first registered
          example: "2025-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the token was last updated
          example: "2025-01-15T10:30:00Z"
    
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          description: Error message describing what went wrong
          example: "Either phone_number (for customers) or admin_email (for admins) must be provided"
        errors:
          type: array
          description: Detailed validation errors (when applicable)
          items:
            type: object
            properties:
              msg:
                type: string
                description: Validation error message
                example: "Phone number must be between 7 and 20 characters"
              param:
                type: string
                description: Parameter name that failed validation
                example: "phone_number"
              location:
                type: string
                description: Location of the parameter (body, query, etc.)
                example: "body"

